"use strict";!function(){var e=ax5.ui,t=ax5.util;e.addClass({className:"uploader",version:"0.0.5"},function(){var i=function(){var i;this.instanceId=ax5.getGuid(),this.config={clickEventName:"click",theme:"default",file_types:"*/*"},this.queue=[],this.target=null,this.selectedFile=null,this.uploadedFile=null,i=this.config,this.init=function(){this.target=$(i.target),this.target.html(this.__get_layout()),this.els={container:this.target.find('[data-ui-els="container"]'),preview:this.target.find('[data-ui-els="preview"]'),"preview-img":this.target.find('[data-ui-els="preview-img"]'),"input-file":this.target.find('[data-ui-els="input-file"]'),progress:this.target.find('[data-ui-els="progress"]'),"progress-bar":this.target.find('[data-ui-els="progress-bar"]')},this.els.preview.bind("click",function(){this.__request_select_file()}.bind(this)),this.els["input-file"].bind("change",function(e){this.__on_select_file(e||window.event)}.bind(this)),function(){var e,t=this.els.container,i=this.els["preview-img"],s=this;t.get(0).addEventListener("dragover",function(s){s.stopPropagation(),s.preventDefault(),i.hide(),e&&clearTimeout(e),t.addClass("dragover")},!1),t.get(0).addEventListener("dragleave",function(s){s.stopPropagation(),s.preventDefault(),e&&clearTimeout(e),e=setTimeout(function(){i.show()},100),t.removeClass("dragover")},!1),t.get(0).addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),t.removeClass("dragover"),s.__on_select_file(e||window.event)},!1)}.call(this),setTimeout(function(){this.__set_size_layout()}.bind(this),1)},this.__get_layout=function(){var e=[],t="",s=i.file_types;return e.push('<div class="ax5-ui-single-uploader '+i.theme+'" data-ui-els="container">'),e.push('<div class="upload-preview" data-ui-els="preview">'),e.push('<img class="upload-preview-img" data-ui-els="preview-img" src="" style="display:none;width:100%;height:100%;" />'),e.push('<span class="empty-msg">'+i.empty_msg+"<span>"),e.push("</div>"),e.push('<div class="ax5-ui-progress '+(i.progress_theme||"")+'" data-ui-els="progress" style="display: none;"><div class="progress-bar" data-ui-els="progress-bar"></div></div>'),e.push('<input type="file" '+t+' accept="'+s+'" capture="camera" data-ui-els="input-file" />'),e.push("</div>"),e.join("")},this.__set_size_layout=this.align=function(){var e=20,t=this.els.progress.height(),i=this.els.container.width(),s=this.els.container.height();0!=i&&0!=s&&this.els.progress.css({left:e,top:s/2-t/2,width:i-2*e})},this.__request_select_file=function(){return!(i.before_select_file&&!i.before_select_file.call())&&void(window.imagePicker?window.imagePicker.getPictures(function(e){for(var t=0;t<e.length;t++)console.log("Image URI: "+e[t]);_this.__on_select_file(e)},function(e){console.log("Error: "+e)}):this.els["input-file"].trigger("click"))},this.__on_select_file=function(e){var t,s=this.target.id,a=this.els["preview-img"].get(0);if("dataTransfer"in e?t=e.dataTransfer.files[0]:"target"in e?t=e.target.files[0]:e&&(t=e[0]),!t)return!1;if(this.selected_file=t,function(e){function i(t,i,s){var a={},n=new Image;n.src=t.src,n.onload=function(){this.width>this.height?this.height>s?(a={width:this.width*(s/this.height),height:s},a.left=(i-a.width)/2):(a={width:this.width,height:this.height},a.top=(s-a.height)/2):this.width>i?(a={height:this.height*(i/this.width),width:i},a.top=(s-a.height)/2):(a={width:this.width,height:this.height},a.left=(i-a.width)/2),console.log(a),e.els["preview-img"].css(a)}}if(e.els["preview-img"].css({display:"block"}),window.imagePicker)a.src=t,i(a,e.els.container.width(),e.els.container.height());else{var n=new FileReader(s);n.onloadend=function(){try{a.src=n.result,i(a,e.els.container.width(),e.els.container.height())}catch(t){console.log(t)}},t&&n.readAsDataURL(t)}}(this),i.on_event){var n={action:"fileselect",file:t};i.on_event.call(n,n)}},this.upload=function(){var e=this;if(!this.selected_file){if(i.on_event){var s={action:"error",error:ax5.info.get_error("single-uploader","460","upload")};i.on_event.call(s,s)}return this}var a=new FormData,n=this.els["progress-bar"];this.els.progress.css({display:"block"}),n.css({width:"0%"}),window.imagePicker?a.append(i.upload_http.filename_param_key,this.selected_file):a.append(i.upload_http.filename_param_key,this.selected_file);for(var l in i.upload_http.data)a.append(l,i.upload_http.data[l]);this.xhr=new XMLHttpRequest,this.xhr.open(i.upload_http.method,i.upload_http.url,!0),this.xhr.onload=function(i){var s=i.target.response;try{"string"==typeof s&&(s=t.parseJson(s))}catch(i){return console.log(i),!1}return s.error?(console.log(s.error),!1):void e.upload_complete(s)},this.xhr.upload.onprogress=function(i){n.css({width:t.number(i.loaded/i.total*100,{round:2})+"%"}),i.lengthComputable&&i.loaded>=i.total&&setTimeout(function(){e.els.progress.css({display:"none"})},300)},this.xhr.send(a)},this.upload_complete=function(e){if(this.selected_file=null,this.uploaded_file=e,this.els.container.addClass("uploaded"),i.on_event){var t={action:"uploaded",file:e};i.on_event.call(t,t)}},this.set_uploaded_file=function(e){this.uploaded_file=e,this.uploaded_file?this.els.container.addClass("uploaded"):this.els.container.removeClass("uploaded")},this.set_preview_img=function(e){e?this.els["preview-img"].attr({src:e}).show():this.els["preview-img"].attr({src:null}).hide()},this.main=function(){e.uploader_instance=e.uploader_instance||[],e.uploader_instance.push(this),arguments&&t.isObject(arguments[0])&&this.setConfig(arguments[0])}.apply(this,arguments)};return i}())}();